name: Build Android APK

on:
    push:
        branches: [mobile]

env:
    APP_NAME: Secon Hack

jobs:
    build:
        name: Build APK
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Get short SHA
              id: vars
              run: echo "SHORT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

            - name: Set up JDK
              uses: actions/setup-java@v3
              with:
                  distribution: 'temurin'
                  java-version: '21'

            - name: Setup Gradle cache
              uses: gradle/actions/setup-gradle@v4

            - name: Set gradlew executable permission
              run: chmod +x ./android/gradlew

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: Install npm dependencies
              run: npm install

            - name: Build Android with npm
              run: npm run build:android

            - name: Build APK
              working-directory: android
              run: ./gradlew assemble

            - name: Compute checksum and rename APK
              run: |
                  APK_PATH="android/app/build/outputs/apk/debug/app-debug.apk"
                  CHECKSUM=$(sha256sum "$APK_PATH" | cut -c1-8)
                  NEW_NAME="app-debug-${CHECKSUM}.apk"
                  mv "$APK_PATH" "$NEW_NAME"
                  echo "APK_NAME=$NEW_NAME" >> $GITHUB_ENV

            - name: Create Release (if not exists)
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: mobile-${{ env.SHORT_SHA }}
                  name: 'Build ${{ env.SHORT_SHA }}'
                  draft: false
                  prerelease: false

            - name: Upload APK to Release
              uses: softprops/action-gh-release@v1
              with:
                  files: ${{ env.APK_NAME }}

            # - name: Upload APK
            #   uses: actions/upload-artifact@v4
            #   with:
            #       name: '${{ env.APP_NAME }}-${{ env.SHORT_SHA }}'
            #       path: android/app/build/outputs/apk/debug/app-debug.apk
